@page "/hobby"
@attribute [Authorize]
@using BlazorServer.Components.Account
@using BlazorServer.Data
@rendermode InteractiveServer
@using BlazorServer.Services
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Identity.EntityFrameworkCore
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims

@inject HobbyService hobbyService
@inject ApplicationDbContext Db
@inject IdentityUserAccessor UserAccessor
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>HobbyEditor</PageTitle>

<div class="container-fluid">

    <div class="d-flex justify-content-between">
        <a href="/Account/Manage/Hobbies">Back</a>
    <button type="button" class="btn btn-primary" @onclick="SaveChanges">Save Hobbies</button>
    </div>

    <h1 class="text-center"> What are you interested in?</h1>

    <div class="input-group">
        <span class="input-group-text" id="hobby-search-addon"><span class="bi bi-search"></span></span>
        <input type="text" class="form-control" placeholder="Search for hobbies..." aria-label="Search"
            aria-describedby="hobby-search-addon" @bind-value="SearchText" @bind-value:event="oninput">
    </div>


    <div id="myHobbies" class="d-flex justify-content-around flex-wrap">
        @foreach (var hobby in myHobbies)
        {
            <button type="button" @onclick="(() => RemoveHobby(hobby))"
                class="btn rounded-pill @(myHobbies.Contains(hobby) ? myHobbyClass : otherHobbyClass)">
                @hobby.HobbyName
            </button>
        }
    </div>


    <div class="d-flex justify-content-around flex-wrap">
        @foreach (var hobby in filteredHobbies)
        {
            <button type="button" @onclick="(() => AddHobby(hobby))"
                class="btn rounded-pill @(otherHobbies.Contains(hobby) ? otherHobbyClass : myHobbyClass)">
                @hobby.HobbyName
            </button>
        }

    </div>

</div>


@code {

    private ApplicationUser dbUser = default!;

    private string myHobbyClass = "btn rounded-pill my-hobby";

    private string otherHobbyClass = "btn rounded-pill other-hobby";

    private List<Hobby> myHobbies = new List<Hobby>();

    private List<Hobby> otherHobbies = new List<Hobby>();

    private void RemoveHobby(Hobby hobby)
    {
        myHobbies.Remove(hobby);
        otherHobbies.Add(hobby);
    }

    private void AddHobby(Hobby hobby)
    {
        otherHobbies.Remove(hobby);
        myHobbies.Add(hobby);
    }

    private async Task SaveChanges()
    {
        dbUser.Hobbies = myHobbies;
        await Db.SaveChangesAsync();
    }

    // Logic for searching
    public string SearchText = "";

    private List<Hobby> filteredHobbies => otherHobbies.Where(
    hobby => hobby.HobbyName.ToLower().Contains(SearchText.ToLower())
    ).ToList();

    // when it all starts up
    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated ?? (user!=null && user.Identity != null))
        {
            // User is authenticated
            var username = user.Identity.Name; // Get username
            var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value; // Get user ID
                                                                           // ... access other claims as needed
            Console.WriteLine("HERE WE ARE USER " + userId);
            Console.WriteLine("AND YOR NAME: " + username);

            dbUser = await Db.Users
                .Include(u => u.Hobbies)
                .FirstOrDefaultAsync(u => u.Id == userId)
                ?? throw new NullReferenceException();
            Console.WriteLine("DB USER: " + dbUser.UserName);
            
            myHobbies = dbUser.Hobbies?.ToList() ?? new List<Hobby>();
            Console.WriteLine("my hobbies = " + myHobbies.Count);
            var dbHobbies = await hobbyService.GetHobbiesAsync();

            otherHobbies = dbHobbies.Where(hobby => !myHobbies.Contains(hobby) ).ToList();
        }
        else
        {
            // User is not authenticated
        }
    }



}